<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>cenpy.products &#8212; cenpy v1.0.0 Manual</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pysal-styles.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../../_static/cenpy_favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          cenpy</a>
        <span class="navbar-text navbar-version pull-left"><b>1.0.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../api.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#exploration-tools">Exploration Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#product-american-community-survey">Product: American Community Survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#product-decennial-2010-census">Product: Decennial 2010 Census</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#architectural-component-apiconnection">Architectural Component: APIConnection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#architectural-component-tigerconnection">Architectural Component: TigerConnection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#architectural-component-esrilayer">Architectural Component: ESRILayer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#id1">Architectural Component: APIConnection</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for cenpy.products</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.remote</span> <span class="k">import</span> <span class="n">APIConnection</span>
<span class="kn">from</span> <span class="nn">.explorer</span> <span class="k">import</span> <span class="n">fips_table</span> <span class="k">as</span> <span class="n">_ft</span>
<span class="kn">from</span> <span class="nn">shapely</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="k">import</span> <span class="n">fuzz</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">_places</span> <span class="o">=</span> <span class="n">_ft</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">)</span>
<span class="n">_places</span><span class="p">[</span><span class="s1">&#39;TARGETFP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_places</span><span class="o">.</span><span class="n">PLACEFP</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
<span class="n">_places</span><span class="p">[</span><span class="s1">&#39;TARGETNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_places</span><span class="o">.</span><span class="n">PLACENAME</span>
<span class="n">_places</span><span class="p">[</span><span class="s1">&#39;STATEFP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_places</span><span class="o">.</span><span class="n">STATEFP</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
<span class="n">_places</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;PLACEFP&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNCSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTY&#39;</span><span class="p">,</span> <span class="s1">&#39;PLACENAME&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Decennial2010&#39;</span><span class="p">,</span> <span class="s1">&#39;ACS&#39;</span><span class="p">]</span>

<span class="n">_ACS_MISSING</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">999999999</span><span class="p">,</span> <span class="o">-</span><span class="mi">888888888</span><span class="p">,</span> <span class="o">-</span><span class="mi">666666666</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">555555555</span><span class="p">,</span> <span class="o">-</span><span class="mi">333333333</span><span class="p">,</span> <span class="o">-</span><span class="mi">222222222</span><span class="p">)</span>

<div class="viewcode-block" id="_Product"><a class="viewcode-back" href="../../generated/cenpy.products._Product.html#cenpy.products._Product">[docs]</a><span class="k">class</span> <span class="nc">_Product</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The fundamental building block to make pre-configured Census Products, like ACS or Decennial2010.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All variables, including columns and search predictates,</span>
<span class="sd">         available from the API&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the main table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include crosstabulations, like &quot;Sex by Age (White Alone)&quot;,</span>
<span class="sd">        whose table numbers end in characters (like B01001A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@tables</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the main table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include crosstabulations, like &quot;Sex by Age (White Alone)&quot;,</span>
<span class="sd">        whose table numbers end in characters (like B01001A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This must be implemented on children of this class!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="_Product.filter_variables"><a class="viewcode-back" href="../../generated/cenpy.products._Product.filter_variables.html#cenpy.products._Product.filter_variables">[docs]</a>    <span class="k">def</span> <span class="nf">filter_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;re&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">varslike</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span></div>
    <span class="n">filter_variables</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">APIConnection</span><span class="o">.</span><span class="n">varslike</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="_Product.filter_tables"><a class="viewcode-back" href="../../generated/cenpy.products._Product.filter_tables.html#cenpy.products._Product.filter_tables">[docs]</a>    <span class="k">def</span> <span class="nf">filter_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;re&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter tables by a given pattern. Consult filter_variables for options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">varslike</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> 
                                  <span class="n">within</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_preprocess_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">this_pattern</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filter_variables</span><span class="p">(</span><span class="n">this_pattern</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;regex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">expanded</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_layer_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The lookup table relating the layers in the WMS service and the levels</span>
<span class="sd">        supported by this API product.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@_layer_lookup</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">_layer_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This must be implemented on children &#39;</span>
                                  <span class="s1">&#39;of this class!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="_Product.from_place"><a class="viewcode-back" href="../../generated/cenpy.products._Product.from_place.html#cenpy.products._Product.from_place">[docs]</a>    <span class="k">def</span> <span class="nf">from_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">place_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">geometry_precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">strict_within</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">replace_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the Census for the given place. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        place               : str</span>
<span class="sd">                              description of the place. Should be of the form</span>
<span class="sd">                              &quot;place, state&quot; or &quot;place&quot;</span>
<span class="sd">        place_type          : str</span>
<span class="sd">                              type of place to focus on, Incorporated Place, County Subdivision, or Census Designated Place. </span>
<span class="sd">        variables           : list or str</span>
<span class="sd">                              variable or set of variables to extract from the</span>
<span class="sd">                              API. Can include regex columns, which will match</span>
<span class="sd">                              to any column in the product. So, [&#39;P001001&#39;, &#39;^P002&#39;]</span>
<span class="sd">                              will match to P001001 and any column that starts with P002.</span>
<span class="sd">        level               : str (default: &#39;tract&#39;)</span>
<span class="sd">                              level at which to extract the geographic data. May be</span>
<span class="sd">                              limited by some products to only involve tracts. (default: &#39;tract&#39;)</span>
<span class="sd">        return_geometry     : bool</span>
<span class="sd">                              whether to return the geometries of the queried records. True by default, this will ensure</span>
<span class="sd">                              that the return type of from_place is a geopandas.GeoDataFrame. If False, then only the </span>
<span class="sd">                              records are fetched; none of the records&#39; geometries are requested from the server. (default: True) </span>
<span class="sd">        geometry_precision  : int </span>
<span class="sd">                              number of decimal places to preserve when getting the geometric</span>
<span class="sd">                              information around each observation in `level`. (default: 2)</span>
<span class="sd">        strict_within       : bool</span>
<span class="sd">                              whether to retain only geometries that are fully within the</span>
<span class="sd">                              target place.</span>
<span class="sd">        return_bounds       : bool </span>
<span class="sd">                              whether to return the boundary of the place being queried. (default: False)</span>
<span class="sd">        replace_missing     : bool </span>
<span class="sd">                              whether to replace missing values in the data with numpy.nan,</span>
<span class="sd">                              according to the standard missing values used by the ACS. (default: True)</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        ------</span>

<span class="sd">        You should always try to provide a place_type. There is a significant amount of vagueness in what is meant</span>
<span class="sd">        by &quot;place&quot; that you may not get the match you intend if you do not provide a place_type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span>
        
        <span class="n">name</span> <span class="o">=</span> <span class="n">place</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Uncertain place identifier &quot;</span><span class="si">{}</span><span class="s1">&quot;. The place identifier should &#39;</span>
                 <span class="s1">&#39;look something like &quot;placename, state&quot; or, for larger areas, &#39;</span>
                 <span class="s1">&#39;like Combined Statistical Areas or Metropolitan Statistical Areas,&#39;</span>
                 <span class="s1">&#39;&quot;placename1-placename2, state1-state2-state3&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">place</span><span class="p">),</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


        <span class="k">if</span><span class="p">(</span><span class="n">place_type</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">place_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Census Designated Place&#39;</span><span class="p">,</span> <span class="s1">&#39;Incorporated Place&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;County Subdivision&#39;</span><span class="p">]):</span>
                <span class="n">searchtarget</span> <span class="o">=</span> <span class="n">_places</span><span class="p">[</span><span class="n">_places</span><span class="p">[</span><span class="s1">&#39;TYPE&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">place_type</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;place_type must be on of Census Designated Place, Incorporated Place, County Subdivision&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">searchtarget</span> <span class="o">=</span> <span class="n">_places</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">TypeOrder</span> <span class="o">=</span> <span class="n">_places</span><span class="p">[</span><span class="s1">&#39;TYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="p">{})</span> <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">searchtarget</span> <span class="o">=</span> <span class="n">searchtarget</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">_places</span><span class="o">.</span><span class="n">STATE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>\
                                  <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;state == &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>\
                                  <span class="o">.</span><span class="n">TARGETNAME</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">searchtarget</span> <span class="o">=</span> <span class="n">searchtarget</span><span class="o">.</span><span class="n">TARGETNAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>

        <span class="n">placematch</span> <span class="o">=</span> <span class="n">_fuzzy_match</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">searchtarget</span><span class="p">)</span>
        <span class="n">placerow</span> <span class="o">=</span> <span class="n">_places</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">placematch</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">env_name</span> <span class="o">=</span> <span class="n">_fuzzy_match</span><span class="p">(</span><span class="n">placerow</span><span class="o">.</span><span class="n">TYPE</span><span class="p">,</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">])</span>

        <span class="n">env_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">env_name</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">place_type</span> <span class="o">==</span> <span class="s1">&#39;County Subdivision&#39;</span><span class="p">:</span>
            <span class="n">placer</span> <span class="o">=</span> <span class="s1">&#39;STATE=</span><span class="si">{}</span><span class="s1"> AND COUSUB=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">placerow</span><span class="o">.</span><span class="n">STATEFP</span><span class="p">,</span>
                                                    <span class="n">placerow</span><span class="o">.</span><span class="n">TARGETFP</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">placer</span> <span class="o">=</span> <span class="s1">&#39;STATE=</span><span class="si">{}</span><span class="s1"> AND PLACE=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">placerow</span><span class="o">.</span><span class="n">STATEFP</span><span class="p">,</span>
                                                    <span class="n">placerow</span><span class="o">.</span><span class="n">TARGETFP</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">env_layer</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">placer</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Matched: </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1"> &#39;</span>
              <span class="s1">&#39;within layer </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">place</span><span class="p">,</span>
                                       <span class="n">placematch</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                       <span class="n">env_layer</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(ESRILayer) &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>

        <span class="n">geoms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bbox</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">,</span>
                                      <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                      <span class="n">return_geometry</span><span class="o">=</span><span class="n">return_geometry</span><span class="p">,</span>
                                      <span class="n">geometry_precision</span><span class="o">=</span><span class="n">geometry_precision</span><span class="p">,</span>
                                      <span class="n">strict_within</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">replace_missing</span><span class="o">=</span><span class="n">replace_missing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strict_within</span><span class="p">:</span>
            <span class="n">geoms</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">env</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]],</span>
                                     <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;within&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">geoms</span><span class="p">,</span> <span class="n">data</span></div>

<div class="viewcode-block" id="_Product._from_bbox"><a class="viewcode-back" href="../../generated/cenpy.products._Product._from_bbox.html#cenpy.products._Product._from_bbox">[docs]</a>    <span class="k">def</span> <span class="nf">_from_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounding_box</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">geometry_precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">strict_within</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                   <span class="n">replace_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is an internal method to handle querying the Census API and the GeoAPI using</span>
<span class="sd">        bounding boxes. This first gets the target records in the given level that fall within</span>
<span class="sd">        the provided bounding box using the GeoAPI. Then, it gets the variables for each record</span>
<span class="sd">        from the Census API. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Regularize the bounding box for the web request</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">geometry</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bounding_box</span><span class="p">)])</span>
        <span class="n">envelope</span> <span class="o">=</span> <span class="s1">&#39;%2C&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">bounding_box</span><span class="p">))</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_layer_lookup</span><span class="p">[</span><span class="n">level</span><span class="p">]]</span>
        <span class="n">involved</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">geometryType</span><span class="o">=</span><span class="s1">&#39;esriGeometryEnvelope&#39;</span><span class="p">,</span>
                               <span class="n">geometry</span><span class="o">=</span><span class="n">envelope</span><span class="p">,</span> 
                               <span class="n">returnGeometry</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
                               <span class="n">inSR</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
                               <span class="n">spatialRel</span><span class="o">=</span><span class="s1">&#39;esriSpatialRelIntersects&#39;</span><span class="p">,</span>
                               <span class="n">geometryPrecision</span><span class="o">=</span><span class="n">geometry_precision</span><span class="p">)</span>
        <span class="c1"># filter the records by a strict &quot;within&quot; query if needed</span>
        <span class="k">if</span> <span class="n">strict_within</span><span class="p">:</span>
            <span class="n">involved</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">involved</span><span class="p">,</span> <span class="n">env</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]],</span>
                                       <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;within&#39;</span><span class="p">)</span>
        
        <span class="c1"># Construct a &quot;query&quot; translator between the GeoAPI and the Census API</span>
        <span class="c1"># in chunks using a closure around chunked_query. </span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;county&#39;</span><span class="p">:</span>
            <span class="n">grouper</span> <span class="o">=</span> <span class="n">involved</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;STATE&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grouper</span> <span class="o">=</span> <span class="n">involved</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;STATE&#39;</span><span class="p">,</span><span class="s1">&#39;COUNTY&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">grouper</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">ix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">state</span><span class="p">,</span> <span class="n">county</span> <span class="o">=</span> <span class="n">ix</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;county&#39;</span><span class="p">,</span><span class="s1">&#39;state&#39;</span><span class="p">):</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">COUNTY</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">elements</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">TRACT</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">chunked_query</span><span class="p">(</span><span class="n">elements_in_chunk</span><span class="p">):</span>
                <span class="n">geo_filter</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;block&#39;</span><span class="p">:</span>
                    <span class="n">geo_unit</span> <span class="o">=</span> <span class="s1">&#39;block:*&#39;</span>
                    <span class="n">geo_filter</span><span class="p">[</span><span class="s1">&#39;tract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements_in_chunk</span><span class="p">)</span>
                    <span class="n">geo_filter</span><span class="p">[</span><span class="s1">&#39;county&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">county</span>
                <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;tract&#39;</span><span class="p">:</span>
                    <span class="n">geo_unit</span> <span class="o">=</span> <span class="s1">&#39;tract:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements_in_chunk</span><span class="p">))</span>
                    <span class="n">geo_filter</span><span class="p">[</span><span class="s1">&#39;county&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">county</span>
                <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;county&#39;</span><span class="p">:</span>
                    <span class="n">geo_unit</span> <span class="o">=</span> <span class="s1">&#39;county:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements_in_chunk</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;state&#39;</span><span class="p">:</span>
                    <span class="n">geo_filter</span><span class="o">=</span><span class="kc">None</span>
                    <span class="n">geo_unit</span><span class="o">=</span><span class="s1">&#39;state:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements_in_chunk</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unrecognized level: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">geo_unit</span><span class="o">=</span><span class="n">geo_unit</span><span class="p">,</span> <span class="n">geo_filter</span><span class="o">=</span><span class="n">geo_filter</span><span class="p">)</span>
            
            <span class="c1"># Run each of these chunks of the query in order to avoid requesting too much data. </span>
            <span class="n">n_chunks</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_elements</span> <span class="o">/</span> <span class="mi">500</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">chunked_query</span><span class="p">(</span><span class="n">tracts_</span><span class="p">)</span> <span class="k">for</span> <span class="n">tracts_</span> <span class="ow">in</span>
                                      <span class="n">numpy</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">n_chunks</span><span class="p">)],</span>
                                      <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="n">replace_missing</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">_replace_missing</span><span class="p">(</span><span class="n">_coerce</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="nb">float</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_geometry</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">involved</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">geometry</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">bounding_box</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">involved</span><span class="p">,</span> <span class="n">data</span></div>

    <span class="k">def</span> <span class="nf">_environment_from_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">layername</span><span class="p">,</span> <span class="n">geometry_precision</span><span class="p">,</span> 
                                <span class="n">cache_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function to extract the right &quot;container&quot;, or &quot;environment&quot; to</span>
<span class="sd">        conduct a query against. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layername_match</span> <span class="o">=</span> <span class="n">_fuzzy_match</span><span class="p">(</span><span class="n">layername</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
                                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">])</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layername_match</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">item_name</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_match</span><span class="p">(</span><span class="n">place</span><span class="p">,</span> <span class="n">layername</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">,</span> 
                                            <span class="n">return_table</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache_name</span> <span class="o">=</span> <span class="n">layername_match</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;(ESRILayer) &#39;</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">cache_name</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">item_name</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">layer</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="s1">&#39;GEOID=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">GEOID</span><span class="p">),</span>
                           <span class="n">geometryPrecision</span><span class="o">=</span><span class="n">geometry_precision</span><span class="p">)</span>

<div class="viewcode-block" id="_Product._from_name"><a class="viewcode-back" href="../../generated/cenpy.products._Product._from_name.html#cenpy.products._Product._from_name">[docs]</a>    <span class="k">def</span> <span class="nf">_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                   <span class="n">layername</span><span class="p">,</span> <span class="n">strict_within</span><span class="p">,</span> <span class="n">return_bounds</span><span class="p">,</span> 
                   <span class="n">geometry_precision</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function, internal to the product, which pieces together the </span>
<span class="sd">        construction of a bounding box (from environment_from_layer) and </span>
<span class="sd">        the querying of the GeoAPI using that bounding box in (from_bbox)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environment_from_layer</span><span class="p">(</span><span class="n">place</span><span class="p">,</span> <span class="n">layername</span><span class="p">,</span> <span class="n">geometry_precision</span><span class="p">,</span> 
                                           <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">)</span>
        <span class="n">geoms</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bbox</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">,</span>
                                      <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                      <span class="n">strict_within</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">replace_missing</span><span class="o">=</span><span class="n">replace_missing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strict_within</span><span class="p">:</span>
            <span class="n">geoms</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">env</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]],</span>
                                    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;within&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">geoms</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">env</span>
        <span class="k">return</span> <span class="n">geoms</span><span class="p">,</span> <span class="n">data</span></div>

<div class="viewcode-block" id="_Product.check_match"><a class="viewcode-back" href="../../generated/cenpy.products._Product.check_match.html#cenpy.products._Product.check_match">[docs]</a>    <span class="k">def</span> <span class="nf">check_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">return_level</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function to verify the match used by the product API. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name        : str</span>
<span class="sd">                      the name of the place/query string to be searched. Should be in the form</span>
<span class="sd">                      &quot;placename, stateabbreviation&quot; (like &quot;Los Angeles, CA&quot;). For multiply-named</span>
<span class="sd">                      locations, the format should be town1-town2, state1-state2, like Kansas City, KS-MO. </span>
<span class="sd">        level       : str</span>
<span class="sd">                      the name of the census hierarchy in which the name should be searched. Should be</span>
<span class="sd">                      something like &quot;Incorporated Places&quot; or &quot;States&quot;. </span>
<span class="sd">        return_level: bool</span>
<span class="sd">                      Whether to return the level match. If you are uncertain as to which level the name</span>
<span class="sd">                      is matching, set this flag to `True` to see the Census API layer that matches. </span>
<span class="sd">        return_table: bool</span>
<span class="sd">                      Whether to return the full table of possible matches for the queried name or level. </span>
<span class="sd">                      If this is true, the return values are converted to be tuples, containing (match, table),</span>
<span class="sd">                      where &quot;match&quot; is the entity in the Census API that matches the requested name or level,</span>
<span class="sd">                      and table is the set of *all* possible values that could have been matched. If the matching</span>
<span class="sd">                      fails for your first run, try inspecting table using return_table=True. Find the place/name</span>
<span class="sd">                      you intend to match, and then input exactly that string. </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            the row of the match table that records the matched name. </span>
<span class="sd">            If return_table is True, this becomes a tuple of (row, table). </span>
<span class="sd">            If return_level is True, the result is returned for both the match on the name and on the level.</span>
<span class="sd">            If both return_table and return_level are true, then two tuples are returned. The first contains the</span>
<span class="sd">            match for the name and the full table of possible names, and the second contains the match of the level and </span>
<span class="sd">        the full table of possible levels. </span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        matches are made based on the `partial_ratio` and `ratio` scorings from the fuzzywuzzy package. The `partial_ratio` </span>
<span class="sd">        prioritizes the &quot;target&quot; being fully contained in the match. So, a string like `Chicago, IL` would be a perfect </span>
<span class="sd">        match for `Chicago, IL` as well as &#39;North Chicago, IL&#39; or `Chicago Heights, IL`. If there are ties (which happens often),</span>
<span class="sd">        the `ratio` percentage is used to break them. This considers the full string similarity, so that the closest</span>
<span class="sd">        full strings are matched. This ensures that `Chicago, IL` is matched to `Chicago, IL`, and not `West Chicago, IL`. </span>

<span class="sd">        Consult the fuzzywuzzy package documentation for more information on the `partial_ratio`</span>
<span class="sd">        and `ratio` matches. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_result</span> <span class="o">=</span> <span class="n">_fuzzy_match</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">],</span> 
                                   <span class="n">return_table</span><span class="o">=</span><span class="n">return_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_table</span><span class="p">:</span>
            <span class="n">layer_name</span><span class="p">,</span> <span class="n">layer_matchtable</span> <span class="o">=</span> <span class="n">layer_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_result</span>
        <span class="n">layer_ix</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">cache_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache_name</span> <span class="o">=</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;(ESRILayer) &#39;</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">mapservice</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_ix</span><span class="p">]</span>
            <span class="n">out_fields</span> <span class="o">=</span> <span class="s1">&#39;BASENAME,GEOID&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;Statistical&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="n">out_fields</span> <span class="o">+=</span> <span class="s1">&#39;,STATE&#39;</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">returnGeometry</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
                                <span class="n">outFields</span><span class="o">=</span><span class="n">out_fields</span><span class="p">,</span>
                                <span class="n">where</span><span class="o">=</span><span class="s1">&#39;AREALAND&gt;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Statistical&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer_name</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
                <span class="n">_states</span> <span class="o">=</span> <span class="n">_ft</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
                <span class="n">_states</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;abbreviation&#39;</span><span class="p">,</span> <span class="s1">&#39;statefp&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">_states</span><span class="p">[</span><span class="s1">&#39;STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_states</span><span class="o">.</span><span class="n">statefp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">_states</span><span class="p">[[</span><span class="s1">&#39;abbreviation&#39;</span><span class="p">,</span> <span class="s1">&#39;STATE&#39;</span><span class="p">]],</span>
                                    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;STATE&#39;</span><span class="p">)</span>
                <span class="n">cache</span><span class="p">[</span><span class="s1">&#39;BASENAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[[</span><span class="s1">&#39;BASENAME&#39;</span><span class="p">,</span> <span class="s1">&#39;abbreviation&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                                                      <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cache_name</span><span class="p">:</span> <span class="n">cache</span><span class="p">})</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_fuzzy_match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cache</span><span class="o">.</span><span class="n">BASENAME</span><span class="p">,</span> <span class="n">return_table</span><span class="o">=</span><span class="n">return_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_level</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">layer_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="Decennial2010"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.html#cenpy.products.Decennial2010">[docs]</a><span class="k">class</span> <span class="nc">Decennial2010</span><span class="p">(</span><span class="n">_Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The 2010 Decennial Census from the Census Bueau&quot;&quot;&quot;</span>
    <span class="n">_layer_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;county&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                     <span class="s1">&#39;tract&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                     <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">}</span>

<div class="viewcode-block" id="Decennial2010.__init__"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.html#cenpy.products.Decennial2010.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Decennial2010</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="n">APIConnection</span><span class="p">(</span><span class="s1">&#39;DECENNIALSF12010&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">set_mapservice</span><span class="p">(</span><span class="s1">&#39;tigerWMS_Census2010&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                   <span class="n">layername</span><span class="p">,</span> 
                   <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">cache_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">strict_within</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry_precision</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Only levels </span><span class="si">{}</span><span class="s1"> are supported. You provided </span><span class="si">{}</span><span class="s1">.&#39;</span>
                                      <span class="s1">&#39;Try picking the state containing that level,&#39;</span>
                                      <span class="s1">&#39; and then selecting from that data after it is&#39;</span>
                                      <span class="s1">&#39; fetched&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">)</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Decennial2010</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_from_name</span>
        <span class="n">geoms</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">caller</span><span class="p">(</span><span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                                         <span class="n">layername</span><span class="p">,</span> <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">,</span>
                                         <span class="n">return_geometry</span><span class="o">=</span><span class="n">return_geometry</span><span class="p">,</span>
                                         <span class="n">strict_within</span><span class="o">=</span><span class="n">strict_within</span><span class="p">,</span>
                                         <span class="n">return_bounds</span><span class="o">=</span><span class="n">return_bounds</span><span class="p">,</span>
                                         <span class="n">geometry_precision</span><span class="o">=</span><span class="n">geometry_precision</span><span class="p">)</span>
        <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">GEO_ID</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">return_table</span> <span class="o">=</span> <span class="n">geoms</span><span class="p">[[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>\
                            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GEOID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_geometry</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">return_table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">return_table</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">)</span>

<div class="viewcode-block" id="Decennial2010.from_place"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.from_place.html#cenpy.products.Decennial2010.from_place">[docs]</a>    <span class="k">def</span> <span class="nf">from_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> 
                   <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">place_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">strict_within</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">replace_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">)</span>

        <span class="n">geoms</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Decennial2010</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>\
                                  <span class="o">.</span><span class="n">from_place</span><span class="p">(</span><span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                              <span class="n">return_geometry</span><span class="o">=</span><span class="n">return_geometry</span><span class="p">,</span>
                                              <span class="n">place_type</span><span class="o">=</span><span class="n">place_type</span><span class="p">,</span>
                                              <span class="n">strict_within</span><span class="o">=</span><span class="n">strict_within</span><span class="p">,</span>
                                              <span class="n">return_bounds</span><span class="o">=</span><span class="n">return_bounds</span><span class="p">,</span>
                                              <span class="n">replace_missing</span><span class="o">=</span><span class="n">replace_missing</span><span class="p">)</span>
        <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">GEO_ID</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">return_table</span> <span class="o">=</span> <span class="n">geoms</span><span class="p">[[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>\
                            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GEOID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_geometry</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">return_table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">return_table</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">)</span></div>
    <span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span><span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span>

<div class="viewcode-block" id="Decennial2010.from_msa"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.from_msa.html#cenpy.products.Decennial2010.from_msa">[docs]</a>    <span class="k">def</span> <span class="nf">from_msa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msa</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">msa</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                               <span class="s1">&#39;Metropolitan Statistical Area&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_msa</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span><span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;MSA&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Decennial2010.from_csa"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.from_csa.html#cenpy.products.Decennial2010.from_csa">[docs]</a>    <span class="k">def</span> <span class="nf">from_csa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csa</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">csa</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                               <span class="s1">&#39;Combined Statistical Area&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_csa</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span><span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;CSA&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Decennial2010.from_county"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.from_county.html#cenpy.products.Decennial2010.from_county">[docs]</a>    <span class="k">def</span> <span class="nf">from_county</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">county</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">county</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                               <span class="s1">&#39;Counties&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_county</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span>\
                                    <span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span>\
                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;county&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Decennial2010.from_state"><a class="viewcode-back" href="../../generated/cenpy.products.Decennial2010.from_state.html#cenpy.products.Decennial2010.from_state">[docs]</a>    <span class="k">def</span> <span class="nf">from_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                               <span class="s1">&#39;States&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_state</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span>\
                                    <span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span>\
                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>\
                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;state, state&quot; or &quot;state&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;state, abbreviation&quot; or &quot;state&quot;&#39;</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the main table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include crosstabulations, like &quot;Sex by Age (White Alone)&quot;,</span>
<span class="sd">        whose table numbers end in characters (like B01001A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="nd">@tables</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the main table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include crosstabulations, like &quot;Sex by Age (White Alone)&quot;,</span>
<span class="sd">        whose table numbers end in characters (like B01001A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tables</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
            <span class="n">unique_concepts</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">concept</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            
            <span class="n">single_unique_concepts</span> <span class="o">=</span> <span class="n">unique_concepts</span><span class="p">[</span><span class="n">unique_concepts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span> <span class="o">=</span> <span class="n">single_unique_concepts</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            
            <span class="n">is_table</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">_can_int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span><span class="p">[</span><span class="n">is_table</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crosstabs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span><span class="p">[</span><span class="o">~</span><span class="n">is_table</span><span class="p">]</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tables</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crosstab_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the crosstab table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include main tables, like &quot;Race&quot;, whose table numbers</span>
<span class="sd">        end in integers (like B02001).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@crosstab_tables</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">crosstab_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the crosstab table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include main tables, like &quot;Race&quot;, whose table numbers</span>
<span class="sd">        end in integers (like B02001).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crosstabs</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="c1">#compute the divisions</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crosstabs</span></div>


<div class="viewcode-block" id="ACS"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.html#cenpy.products.ACS">[docs]</a><span class="k">class</span> <span class="nc">ACS</span><span class="p">(</span><span class="n">_Product</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The American Community Survey (5-year vintages) from the Census Bueau&quot;&quot;&quot;</span>

    <span class="n">_layer_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;county&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
                     <span class="s1">&#39;tract&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

<div class="viewcode-block" id="ACS.__init__"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.html#cenpy.products.ACS.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="s1">&#39;latest&#39;</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="mi">2017</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">2013</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The requested year </span><span class="si">{}</span><span class="s1"> is too early. &#39;</span>
                                      <span class="s1">&#39;Only 2013 and onwards is supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="n">APIConnection</span><span class="p">(</span><span class="s1">&#39;ACSDT</span><span class="si">{}</span><span class="s1">Y</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">set_mapservice</span><span class="p">(</span><span class="s1">&#39;tigerWMS_ACS</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                   <span class="n">layername</span><span class="p">,</span> 
                   <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">cache_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">strict_within</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">geometry_precision</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Only levels </span><span class="si">{}</span><span class="s1"> are supported. You provided </span><span class="si">{}</span><span class="s1">.&#39;</span>
                                      <span class="s1">&#39;Try picking the state containing that level,&#39;</span>
                                      <span class="s1">&#39; and then selecting from that data after it is&#39;</span>
                                      <span class="s1">&#39; fetched&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The American Community Survey is only administered&#39;</span>
                             <span class="s1">&#39; at the blockgroup level or higher. Please select a&#39;</span>
                             <span class="s1">&#39; level at or above the blockgroup level.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">)</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ACS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_from_name</span>
        <span class="n">geoms</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">caller</span><span class="p">(</span><span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                                         <span class="n">layername</span><span class="p">,</span> 
                                         <span class="n">return_geometry</span><span class="o">=</span><span class="n">return_geometry</span><span class="p">,</span>
                                         <span class="n">cache_name</span><span class="o">=</span><span class="n">cache_name</span><span class="p">,</span>
                                         <span class="n">strict_within</span><span class="o">=</span><span class="n">strict_within</span><span class="p">,</span>
                                         <span class="n">return_bounds</span><span class="o">=</span><span class="n">return_bounds</span><span class="p">,</span>
                                         <span class="n">geometry_precision</span><span class="o">=</span><span class="n">geometry_precision</span><span class="p">)</span>
        <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">GEO_ID</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">return_table</span> <span class="o">=</span> <span class="n">geoms</span><span class="p">[[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>\
                            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GEOID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_geometry</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">return_table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">return_table</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">)</span>

<div class="viewcode-block" id="ACS.from_msa"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.from_msa.html#cenpy.products.ACS.from_msa">[docs]</a>    <span class="k">def</span> <span class="nf">from_msa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msa</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">msa</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                               <span class="s1">&#39;Metropolitan Statistical Area&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_msa</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span><span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;MSA&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ACS.from_csa"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.from_csa.html#cenpy.products.ACS.from_csa">[docs]</a>    <span class="k">def</span> <span class="nf">from_csa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csa</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">csa</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
                               <span class="s1">&#39;Combined Statistical Area&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_csa</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span><span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;CSA&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ACS.from_county"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.from_county.html#cenpy.products.ACS.from_county">[docs]</a>    <span class="k">def</span> <span class="nf">from_county</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">county</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">county</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;Counties&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_county</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span>\
                                    <span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span>\
                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;county&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ACS.from_state"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.from_state.html#cenpy.products.ACS.from_state">[docs]</a>    <span class="k">def</span> <span class="nf">from_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_name</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="s1">&#39;States&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="n">from_state</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_Product</span>\
                                    <span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span>\
                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span>\
                                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;state, state&quot; or &quot;state&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;state, abbreviation&quot; or &quot;state&quot;&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="ACS.from_place"><a class="viewcode-back" href="../../generated/cenpy.products.ACS.from_place.html#cenpy.products.ACS.from_place">[docs]</a>    <span class="k">def</span> <span class="nf">from_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;tract&#39;</span><span class="p">,</span>
                   <span class="n">return_geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">place_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">strict_within</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">replace_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">)</span>

        <span class="n">geoms</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ACS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>\
                                  <span class="o">.</span><span class="n">from_place</span><span class="p">(</span><span class="n">place</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                                              <span class="n">return_geometry</span><span class="o">=</span><span class="n">return_geometry</span><span class="p">,</span>
                                              <span class="n">place_type</span><span class="o">=</span><span class="n">place_type</span><span class="p">,</span>
                                              <span class="n">strict_within</span><span class="o">=</span><span class="n">strict_within</span><span class="p">,</span>
                                              <span class="n">return_bounds</span><span class="o">=</span><span class="n">return_bounds</span><span class="p">,</span>
                                              <span class="n">replace_missing</span><span class="o">=</span><span class="n">replace_missing</span><span class="p">)</span>
        <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">GEO_ID</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">return_table</span> <span class="o">=</span> <span class="n">geoms</span><span class="p">[[</span><span class="s1">&#39;GEOID&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>\
                            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;GEO_ID&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;GEOID&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_geometry</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">return_table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">return_table</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_bounds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">return_table</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">)</span></div>
    <span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span><span class="n">_Product</span><span class="o">.</span><span class="n">from_place</span><span class="o">.</span><span class="vm">__doc__</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the main table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include crosstabulations, like &quot;Sex by Age (White Alone)&quot;,</span>
<span class="sd">        whose table numbers end in characters (like B01001A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="nd">@tables</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the main table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include crosstabulations, like &quot;Sex by Age (White Alone)&quot;,</span>
<span class="sd">        whose table numbers end in characters (like B01001A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tables</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
            <span class="n">grouper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">split_len</span><span class="o">=</span><span class="n">splits</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                                          <span class="n">table_name</span><span class="o">=</span><span class="n">splits</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>\
                                  <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;split_len == 2&#39;</span><span class="p">)</span>\
                                  <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;table_name&#39;</span><span class="p">)</span>
            <span class="n">stems</span> <span class="o">=</span> <span class="n">grouper</span><span class="o">.</span><span class="n">concept</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
            <span class="n">stems</span><span class="p">[</span><span class="s1">&#39;columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">stems</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;some variables have failed to parse into tables&#39;</span>
            <span class="n">stems</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stems</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">stems</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;GEO&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span> <span class="o">=</span> <span class="n">result</span>
            <span class="c1"># keep around the main tables only if they&#39;re not crosstabs (ending in alphanumeric)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tables</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">ix</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">_can_int</span><span class="p">(</span><span class="n">ix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tables</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crosstab_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the crosstab table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include main tables, like &quot;Race&quot;, whose table numbers</span>
<span class="sd">        end in integers (like B02001).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@crosstab_tables</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span> <span class="nf">crosstab_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All of the crosstab table codes in the Census API for this product. </span>
<span class="sd">        </span>
<span class="sd">        These *do not* include main tables, like &quot;Race&quot;, whose table numbers</span>
<span class="sd">        end in integers (like B02001).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crosstabs</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="c1"># needs to be instantiated first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crosstabs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stems</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stems</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crosstabs</span></div>

<span class="c1">#############</span>
<span class="c1"># UTILITIES #</span>
<span class="c1">#############</span>

<span class="k">def</span> <span class="nf">_fuzzy_match</span><span class="p">(</span><span class="n">matchtarget</span><span class="p">,</span> <span class="n">matchlist</span><span class="p">,</span> <span class="n">return_table</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conduct a fuzzy match with matchtarget, within the list of possible match candidates in matchlist. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    matchtarget :   str</span>
<span class="sd">                 a string to be matched to a set of possible candidates</span>
<span class="sd">    matchlist   :   list of str</span>
<span class="sd">                 a list (or iterable) containing strings we are interested in matching</span>
<span class="sd">    return_table:   bool</span>
<span class="sd">                 whether to return the full table of scored candidates, or to return only the single</span>
<span class="sd">                 best match. If False (the default), only the best match is returned.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    consult the docstring for Product.check_match for more information on how the actual matching</span>
<span class="sd">    algorithm works. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">matchtarget</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">split</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Uncertain place identifier </span><span class="si">{}</span><span class="s1">. The place identifier should &#39;</span>
                             <span class="s1">&#39;look something like &quot;placename, state&quot; or, for larger areas, &#39;</span>
                             <span class="s1">&#39;like Combined Statistical Areas or Metropolitan Statistical Areas,&#39;</span>
                             <span class="s1">&#39;placename1-placename2, state1-state2-state3&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span><span class="n">matchlist</span><span class="p">})</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">target</span>\
                          <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">partial_ratio</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                              <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">score</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ixmax</span><span class="p">,</span> <span class="n">rowmax</span> <span class="o">=</span> <span class="n">_break_ties</span><span class="p">(</span><span class="n">matchtarget</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ixmax</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="n">rowmax</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixmax</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rowmax</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowmax</span>

    <span class="n">in_state</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">in_state</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;State </span><span class="si">{}</span><span class="s1"> is not found from place </span><span class="si">{}</span><span class="s1">. &#39;</span>
                           <span class="s1">&#39;Should be a standard Census abbreviation, like&#39;</span>
                           <span class="s1">&#39; CA, AZ, NC, or PR&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matchtarget</span><span class="p">))</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">in_state</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">score</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ixmax</span><span class="p">,</span> <span class="n">rowmax</span> <span class="o">=</span> <span class="n">_break_ties</span><span class="p">(</span><span class="n">matchtarget</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ixmax</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="n">rowmax</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixmax</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_table</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rowmax</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rowmax</span>

<span class="k">def</span> <span class="nf">_coerce</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converty type of column to kind, or keep column unchanged</span>
<span class="sd">    if that conversion fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">column</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">column</span>

<span class="k">def</span> <span class="nf">_replace_missing</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">missings</span><span class="o">=</span><span class="n">_ACS_MISSING</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    replace ACS missing values using numpy.nan. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_ACS_MISSING</span><span class="p">:</span>
        <span class="n">column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">column</span>

<span class="k">def</span> <span class="nf">_break_ties</span><span class="p">(</span><span class="n">matchtarget</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    break ties in the fuzzy matching algorithm using a second scoring method </span>
<span class="sd">    which prioritizes full string matches over substring matches.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">matchtarget</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">target</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">split</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">table</span><span class="p">[</span><span class="s1">&#39;score2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                              <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
    <span class="n">among_winners</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">score</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">double_winners</span> <span class="o">=</span> <span class="n">among_winners</span><span class="p">[</span><span class="n">among_winners</span><span class="o">.</span><span class="n">score2</span> <span class="o">==</span> <span class="n">among_winners</span><span class="o">.</span><span class="n">score2</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">double_winners</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ixmax</span> <span class="o">=</span> <span class="n">double_winners</span><span class="o">.</span><span class="n">score2</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="n">ixmax_row</span> <span class="o">=</span> <span class="n">double_winners</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixmax</span><span class="p">]</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Cannot disambiguate placename </span><span class="si">{}</span><span class="s1">. Picking the shortest, best &#39;</span>
             <span class="s1">&#39;matched placename, </span><span class="si">{}</span><span class="s1">, from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matchtarget</span><span class="p">,</span> <span class="n">ixmax_row</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                     <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">double_winners</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
        <span class="k">return</span> <span class="n">ixmax</span><span class="p">,</span> <span class="n">ixmax_row</span>
    <span class="n">ixmax</span> <span class="o">=</span> <span class="n">double_winners</span><span class="o">.</span><span class="n">score2</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ixmax</span><span class="p">,</span> <span class="n">double_winners</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ixmax</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_can_int</span><span class="p">(</span><span class="n">char</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check if a character can be turned into an integer&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2018, cenpy developers.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>